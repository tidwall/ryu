#include <assert.h>
#include <stdio.h>
#include <math.h>
#include <stdlib.h>
#include <string.h>
#include <inttypes.h>
#include "ryu.h"

#define test(fmt, input, expected) { \
    char buf[256]; \
    ryu_string((input), (fmt), buf, sizeof(buf)); \
    if (strcmp(buf, (expected)) != 0) { \
        fprintf(stderr, "line %d: expected %s, got %s\n", \
            __LINE__, (expected), buf); \
        exit(1); \
    } \
}

#define test_j(input) { \
    char buf0[256]; \
    strcpy(buf0, #input); \
    if (buf0[strlen(buf0)-2] == '.') { \
        buf0[strlen(buf0)-2] = '\0'; \
        test('j', input, buf0); \
        test('J', input, buf0); \
    } else { \
        char *e = strchr(buf0, 'e'); \
        if (!e) e = strchr(buf0, 'E'); \
        assert(e); \
        *e = 'e'; \
        test('j', input, buf0); \
        *e = 'E'; \
        test('J', input, buf0); \
    } \
}

int main(void) {
    // test_j(5.307740298202583E+22);
    // // test('j', 5.307740298202583E+22, "5.307740298202583E+22");
    // // test('J', 5.307740298202583E+22, "5.307740298202583E+22");

// return 0;


    test('f', 212123123.123188832, "212123123.12318882");
    test('e', 212123123.123188832, "2.1212312312318882e8");
    test('E', 212123123.123188832, "2.1212312312318882E8");
    test('f', 9223372036854775808.0, "9223372036854776000");
    test('f', 0.000123123001, "0.000123123001");
    test('f', 1.3441331, "1.3441331");
    test('f', 1.0, "1");
    test('f', -1.0, "-1");
    test('f', -0.0, "-0");
    test('f', 0.5, "0.5");
    test('f', -0.5, "-0.5");
    test('f', 0.0, "0");
    test('f', -0.0, "-0");
    test('f', 0.5, "0.5");
    test('f', -0.5, "-0.5");
    test('f', 0.0, "0");
    test('f', -0.01, "-0.01");
    test('f', -0.015, "-0.015");
    test('f', 5000.0, "5000");
    test('f', 0000.0, "0");
    test('f', -0000.0, "-0");
    test('f', 5123.0, "5123");
    test('f', 5000000000000000000.0, "5000000000000000000");
    test('f', -0.00000000000000005, "-0.00000000000000005");
    char buf[32];
    size_t n1 = ryu_string(-112.89123883, 'f', buf, sizeof(buf));
    assert(strcmp(buf, "-112.89123883") == 0);
    size_t n2 = ryu_string(-112.89123883, 'f', NULL, 0);
    assert(n1 == n2);
    size_t n3 = ryu_string(-112.89123883, 'f', buf, 5);
    assert(n3 == n2);
    assert(strcmp(buf, "-112") == 0);
    ryu_string(-112.89123883, 'f', buf, 1);
    assert(strcmp(buf, "") == 0);
    ryu_string(-112.89123883, 'f', buf, 2);
    assert(strcmp(buf, "-") == 0);
    ryu_string(-112.89123883, 'f', buf, 6);
    assert(strcmp(buf, "-112.") == 0);
    test('g', -0.01, "-0.01");
    test('f', 5000000000000000000.0, "5000000000000000000");
    test('e', 5000000000000000000.0, "5e18");
    test('g', 5000000000000000000.0, "5e18");
    test('j', 5000000000000000000.0, "5000000000000000000");
    test('f', 50000000000000000001.0, "50000000000000000000");
    test('e', 50000000000000000001.0, "5e19");
    test('g', 50000000000000000001.0, "5e19");
    test('j', 50000000000000000001.0, "50000000000000000000");
    test('f', 500000000000000000011.0, "500000000000000000000");
    test('e', 500000000000000000011.0, "5e20");
    test('g', 500000000000000000011.0, "5e20");
    test('j', 500000000000000000011.0, "500000000000000000000");
    test('f', -500000000000000000011.0, "-500000000000000000000");
    test('e', -500000000000000000011.0, "-5e20");
    test('g', -500000000000000000011.0, "-5e20");
    test('j', -500000000000000000011.0, "-500000000000000000000");
    test('f', 5000000000000000000111.0, "5000000000000000000000");
    test('e', 5000000000000000000111.0, "5e21");
    test('g', 5000000000000000000111.0, "5e21");
    test('j', 5000000000000000000111.0, "5e+21");
    test('f', -5000000000000000000111.0, "-5000000000000000000000");
    test('e', -5000000000000000000111.0, "-5e21");
    test('g', -5000000000000000000111.0, "-5e21");
    test('j', -5000000000000000000111.0, "-5e+21");
    test('f', 5000, "5000");
    test('g', 5000, "5e3");
    test('f', 500, "500");
    test('g', 500, "500");
    test('g', 500.1, "500.1");
    test('e', 500.1123, "5.001123e2");
    test('g', 500.1123, "500.1123");
    test('e', 500.1123890123, "5.001123890123e2");
    test('g', 500.1123890123, "500.1123890123");
    test('e', 500123.1123890123, "5.001231123890123e5");
    test('g', 500123.1123890123, "500123.1123890123");
    test('e', -500123.1123890123, "-5.001231123890123e5");
    test('g', -500123.1123890123, "-500123.1123890123");
    test('e', 5001237.1123890123, "5.001237112389012e6");
    test('g', 5001237.1123890123, "5001237.112389012");
    test('e', 5001237910.1123890123, "5.001237910112389e9");
    test('g', 5001237910.1123890123, "5001237910.112389");
    test('e', 50012379109182039182.1123890123, "5.001237910918204e19");
    test('g', 50012379109182039182.1123890123, "50012379109182040000");
    test('e', 8888888899999999999999999.0, "8.8888889e24");
    test('g', 8888888899999999999999999.0, "8.8888889e24");
    
    test_j(35499548951617827000.0);
    test_j(2.1622774220303696e+23);
    test_j(426169229454865500000.0);
    test_j(1.1122428779605864e+22);
    test_j(208689857201900700000.0);
    test_j(9.215635951632788e+21);
    test_j(394363363386584860000.0);
    test_j(1.051552966719607e+21);
    test_j(619416341368231300000.0);
    test_j(1.855027370624036e+21);
    test_j(104781779522236330000.0);
    test_j(1.0142892004126468e+21);
    test_j(109047775277613840000.0);
    test_j(1.0842409975308099e+21);
    test_j(9195049728998015000.0);
    test_j(4.778131141654174e+21);
    test_j(62529739735412620000.0);
    test_j(1.1320063478633598e+21);
    test_j(196145233329870600000.0);
    test_j(1.8174708505162005e+21);
    test_j(373792539196554600000.0);
    test_j(3.0212836059446253e+21);
    test_j(72267036244919420000.0);
    test_j(2.664955831891294e+22);
    test_j(52935469346551820000.0);
    test_j(1.2946386961259915e+21);
    test_j(170603629769678500000.0);
    test_j(6.60526142584568e+21);
    test_j(42880714092059600000.0);
    test_j(2.362835377916814e+21);
    test_j(231014740272716150000.0);
    test_j(1.3022371556436764e+21);
    test_j(244316357434306170000.0);
    test_j(2.116436806095811e+21);
    test_j(5602693290733586000.0);
    test_j(1.2231536651405277e+22);
    test_j(15363133420173502000.0);
    test_j(7.964194881065025e+23);
    test_j(3681986271578664000.0);
    test_j(5.875116361313629e+22);
    test_j(115497775565041290000.0);
    test_j(1.5494985062998304e+21);
    test_j(3.332693432432603e+22);
    test_j(426464718456790000000.0);
    test_j(1.7226097008801732e+22);
    test_j(69957914410743990000.0);
    test_j(3.42160911381865e+22);
    test_j(1688019858430556000.0);
    test_j(1.9347549418669543e+22);
    test_j(733425086581656500000.0);
    test_j(2.0748775604932917e+22);
    test_j(147009784738754330000.0);
    test_j(2.086247207898731e+23);
    test_j(987306907069234300000.0);
    test_j(1.489134275661723e+21);
    test_j(629085397883884400000.0);
    test_j(1.5752300766133504e+22);
    test_j(987306907069234300000.0);
    test_j(1.095564255637569e+21);
    test_j(836056326897382300000.0);
    test_j(5.556055204583265e+21);
    test_j(13152608998628676000.0);
    test_j(2.6772291512932968e+23);
    test_j(987306907069234300000.0);
    test_j(2.2811913809996984e+21);
    test_j(29738866232455856000.0);
    test_j(3.8228990573369313e+21);
    test_j(76926234432060640000.0);
    test_j(3.746067584976078e+22);
    test_j(987306907069234300000.0);
    test_j(2.958850611740982e+22);
    test_j(717386127925367700000.0);
    test_j(2.520095981091263e+23);
    test_j(987306907069234300000.0);
    test_j(1.2382226889099641e+22);
    test_j(68438623369146106000.0);
    test_j(1.3567015796774057e+23);
    test_j(56555442318894600000.0);
    test_j(1.11167738462246e+22);
    test_j(28021174372971598000.0);
    test_j(2.467622844932717e+22);
    test_j(540993400866745800000.0);
    test_j(1.2490950941404075e+22);
    test_j(77500474384390620000.0);
    test_j(2.8991807958122163e+22);
    test_j(253113508231971300000.0);
    test_j(5.307740298202583E+22);
    test_j(186872634142835570000.0);
    
    return 0;
}
